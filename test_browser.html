<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Testing</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Comprehensive Chapter/Sub-Chapter/Button Testing</h1>
    
    <div class="test-section">
        <div class="test-title">üìã Test Results Summary</div>
        <div id="test-summary"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üîç API Test Results</div>
        <button onclick="testAPIs()">Run API Tests</button>
        <button onclick="clearResults()" class="btn-secondary">Clear Results</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üñºÔ∏è Visual Testing - Navigate Routes</div>
        <div style="margin-bottom: 10px;">
            <button onclick="navigateTo('/before/stories')">Chapter List</button>
            <button onclick="navigateTo('/before/story/edd348bf-37f3-4232-8fd3-4969a621b92b')">Chapter 1 Detail</button>
            <button onclick="navigateTo('/before/story/edd348bf-37f3-4232-8fd3-4969a621b92b/20e3adc2-f9a4-42d0-bb3d-5d4d0998b58c')">Sub-Chapter 1.1</button>
            <button onclick="navigateTo('/before/ar')">AR Index</button>
        </div>
        <iframe id="test-frame" src="/before/stories"></iframe>
    </div>

    <script>
        let testResults = [];
        
        function addResult(test, status, message, data = null) {
            testResults.push({ test, status, message, data });
            updateSummary();
        }
        
        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const passed = testResults.filter(r => r.status === 'success').length;
            const failed = testResults.filter(r => r.status === 'error').length;
            const info = testResults.filter(r => r.status === 'info').length;
            
            summary.innerHTML = `
                <div class="test-result info">
                    <strong>Total Tests:</strong> ${testResults.length} | 
                    <strong style="color: green">‚úì Passed:</strong> ${passed} | 
                    <strong style="color: red">‚úó Failed:</strong> ${failed} | 
                    <strong style="color: blue">‚Ñπ Info:</strong> ${info}
                </div>
            `;
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('api-results').innerHTML = '';
            updateSummary();
        }
        
        function navigateTo(path) {
            document.getElementById('test-frame').src = path;
        }
        
        async function testAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="test-result info">Running API tests...</div>';
            
            try {
                // Test 1: Get Chapters
                const chaptersRes = await fetch('/api/chapters');
                const chapters = await chaptersRes.json();
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${chapters.length === 3 ? 'success' : 'error'}">
                        <strong>Test 1: Chapter List API</strong><br>
                        Expected: 3 chapters | Found: ${chapters.length}<br>
                        <details>
                            <summary>View Data</summary>
                            <pre>${JSON.stringify(chapters, null, 2)}</pre>
                        </details>
                    </div>
                `;
                addResult('Chapter List API', chapters.length === 3 ? 'success' : 'error', 
                         `Found ${chapters.length} chapters`);
                
                // Test 2: Check AR badges
                const arChapters = chapters.filter(c => c.hasAR);
                resultsDiv.innerHTML += `
                    <div class="test-result ${arChapters.length === 2 ? 'success' : 'error'}">
                        <strong>Test 2: AR Content</strong><br>
                        Expected: 2 chapters with AR | Found: ${arChapters.length}<br>
                        AR Chapters: ${arChapters.map(c => c.title).join(', ')}
                    </div>
                `;
                addResult('AR Content', arChapters.length === 2 ? 'success' : 'error', 
                         `${arChapters.length} chapters with AR`);
                
                // Test 3: Sub-chapter counts
                const subChapterCounts = chapters.map(c => c.subChapterCount).reduce((a, b) => a + b, 0);
                resultsDiv.innerHTML += `
                    <div class="test-result ${subChapterCounts === 5 ? 'success' : 'error'}">
                        <strong>Test 3: Sub-Chapter Counts</strong><br>
                        Expected: 5 total sub-chapters | Found: ${subChapterCounts}<br>
                        By Chapter: ${chapters.map(c => `${c.title}: ${c.subChapterCount}`).join(' | ')}
                    </div>
                `;
                addResult('Sub-Chapter Counts', subChapterCounts === 5 ? 'success' : 'error', 
                         `${subChapterCounts} total sub-chapters`);
                
                // Test 4: Get Sub-chapters for Chapter 1
                const subChaptersRes = await fetch(`/api/sub-chapters?chapterId=${chapters[0].id}`);
                const subChapters = await subChaptersRes.json();
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${subChapters.length === 2 ? 'success' : 'error'}">
                        <strong>Test 4: Sub-Chapters API</strong><br>
                        Chapter 1 sub-chapters: ${subChapters.length}<br>
                        <details>
                            <summary>View Data</summary>
                            <pre>${JSON.stringify(subChapters, null, 2)}</pre>
                        </details>
                    </div>
                `;
                addResult('Sub-Chapters API', subChapters.length === 2 ? 'success' : 'error', 
                         `${subChapters.length} sub-chapters in Chapter 1`);
                
                // Test 5: Check unlock conditions
                const lockedSubChapters = subChapters.filter(sc => sc.unlockConditions && sc.unlockConditions.length > 0);
                resultsDiv.innerHTML += `
                    <div class="test-result ${lockedSubChapters.length === 1 ? 'success' : 'error'}">
                        <strong>Test 5: Unlock Conditions</strong><br>
                        Locked sub-chapters: ${lockedSubChapters.length}<br>
                        ${lockedSubChapters.map(sc => 
                            `${sc.title}: ${sc.unlockConditions[0].type} - ${sc.unlockConditions[0].taskName || sc.unlockConditions[0].stampName || 'Time window'}`
                        ).join('<br>')}
                    </div>
                `;
                addResult('Unlock Conditions', lockedSubChapters.length === 1 ? 'success' : 'error', 
                         `${lockedSubChapters.length} locked sub-chapters`);
                
                // Test 6: Get Story Cards
                const storyCardsRes = await fetch(`/api/story-cards?chapterId=${chapters[0].id}`);
                const storyCards = await storyCardsRes.json();
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${storyCards.length === 2 ? 'success' : 'error'}">
                        <strong>Test 6: Story Cards API</strong><br>
                        Chapter 1 story cards: ${storyCards.length}<br>
                        AR Cards: ${storyCards.filter(sc => sc.hasAR).length}<br>
                        <details>
                            <summary>View Data</summary>
                            <pre>${JSON.stringify(storyCards, null, 2)}</pre>
                        </details>
                    </div>
                `;
                addResult('Story Cards API', storyCards.length === 2 ? 'success' : 'error', 
                         `${storyCards.length} story cards in Chapter 1`);
                
                // Test 7: Check Custom Buttons
                const totalButtons = storyCards.reduce((sum, card) => sum + (card.customButtons?.length || 0), 0);
                const buttonVariants = new Set();
                const buttonDestTypes = new Set();
                
                storyCards.forEach(card => {
                    card.customButtons?.forEach(btn => {
                        buttonVariants.add(btn.variant);
                        buttonDestTypes.add(btn.destinationType);
                    });
                });
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${totalButtons === 4 ? 'success' : 'error'}">
                        <strong>Test 7: Custom Buttons</strong><br>
                        Total buttons on story cards: ${totalButtons}<br>
                        Variants found: ${Array.from(buttonVariants).join(', ')}<br>
                        Destination types: ${Array.from(buttonDestTypes).join(', ')}
                    </div>
                `;
                addResult('Custom Buttons', totalButtons === 4 ? 'success' : 'error', 
                         `${totalButtons} buttons with ${buttonVariants.size} variants`);
                
                // Test 8: AR Index API
                const arIndexRes = await fetch('/api/chapters/ar');
                const arGroups = await arIndexRes.json();
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${arGroups.length === 2 ? 'success' : 'error'}">
                        <strong>Test 8: AR Index API</strong><br>
                        AR chapter groups: ${arGroups.length}<br>
                        <details>
                            <summary>View Data</summary>
                            <pre>${JSON.stringify(arGroups, null, 2)}</pre>
                        </details>
                    </div>
                `;
                addResult('AR Index API', arGroups.length === 2 ? 'success' : 'error', 
                         `${arGroups.length} AR groups`);
                
                // Test 9: Test button with unlock conditions
                const buttonsRes = await fetch(`/api/custom-buttons?parentType=story_card&parentId=010841b5-f249-4fda-bbf6-eebe74fd85d2`);
                const lockedButtons = await buttonsRes.json();
                const hasLockedButton = lockedButtons.some(btn => btn.unlockHint);
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${hasLockedButton ? 'success' : 'info'}">
                        <strong>Test 9: Locked Buttons</strong><br>
                        Found locked button: ${hasLockedButton ? 'Yes' : 'No'}<br>
                        ${lockedButtons.filter(btn => btn.unlockHint).map(btn => 
                            `Button: "${btn.label}" - Hint: "${btn.unlockHint}"`
                        ).join('<br>')}
                    </div>
                `;
                addResult('Locked Buttons', hasLockedButton ? 'success' : 'info', 
                         hasLockedButton ? 'Locked button found' : 'No locked buttons');
                
                resultsDiv.innerHTML += `
                    <div class="test-result success">
                        <strong>‚úÖ All API tests completed!</strong>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="test-result error">
                        <strong>Test Error:</strong> ${error.message}
                    </div>
                `;
                addResult('API Tests', 'error', error.message);
            }
        }
        
        // Run tests on load
        window.addEventListener('load', () => {
            setTimeout(testAPIs, 1000);
        });
    </script>
</body>
</html>